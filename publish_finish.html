<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Shopify</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">

    <div class="max-w-xl w-full bg-white p-8 rounded-xl shadow-2xl border border-gray-200 text-center">
        <h1 class="text-3xl font-bold mb-4 text-gray-900">ğŸš€ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h1>
        <p class="text-gray-600 mb-6">Ø¬Ø§Ø±Ù Ø§Ù„Ø¢Ù† ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙ†Ø´Ø±Ù‡ ÙƒÙ€ 'Section' Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…ØªØ¬Ø± Shopify Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. <br>Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù...</p>
        
        <div id="progress-area" class="mt-8">
            <div id="loading-indicator" class="flex justify-center items-center space-x-3 text-blue-600 font-semibold">
                <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Shopify...</span>
            </div>
            
            <p id="message-area" class="mt-4 text-lg font-medium"></p>
        </div>
        
        <div id="success-actions" class="mt-8 hidden">
            <a id="shopify-link" href="#" target="_blank" class="w-full inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">
                ÙØªØ­ Ø§Ù„Ù…ØªØ¬Ø± (Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)
            </a>
            <p class="text-sm text-gray-500 mt-3">Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù…Ø­Ø±Ø± Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… (Section) Ø§Ù„Ø°ÙŠ ØªÙ… Ù†Ø´Ø±Ù‡.</p>
        </div>
        
        <div id="error-details" class="mt-4 p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 hidden text-sm text-right">
            <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:</strong> <span id="error-text"></span>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', publishSection);

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function publishSection() {
            // ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± Ø¹Ø¨Ø± URL Ù…Ù† shopify_callback.js
            const shop = getQueryParam('shop'); 
            // ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ù† builder.html
            const liquidCode = sessionStorage.getItem('liquid_code');
            const schema = sessionStorage.getItem('schema');
            
            const messageArea = document.getElementById('message-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const successActions = document.getElementById('success-actions');
            const errorDetails = document.getElementById('error-details');
            const errorText = document.getElementById('error-text');

            if (!shop || !liquidCode || !schema) {
                messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù€ builder.html ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.';
                messageArea.style.color = 'red';
                loadingIndicator.classList.add('hidden');
                return;
            }

            const data = {
                shop: shop,
                liquid_code: liquidCode,
                schema: JSON.parse(schema)
            };

            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù†Ø´Ø± Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ù…Ù„Ù api/shopify_publish.js
                const response = await fetch('/api/shopify_publish.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                loadingIndicator.classList.add('hidden');

                if (response.ok && result.success) {
                    messageArea.textContent = `âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù‚Ø³Ù…: ${result.filename}.liquid`;
                    messageArea.style.color = 'green';
                    
                    // Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ù…Ø­Ø±Ø± Ø§Ù„Ø«ÙŠÙ…Ø§Øª
                    const themeEditorLink = `https://${shop}/admin/themes/current/editor?context=apps`;
                    document.getElementById('shopify-link').href = themeEditorLink;
                    successActions.classList.remove('hidden');

                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù†Ø§Ø¬Ø­
                    sessionStorage.removeItem('liquid_code');
                    sessionStorage.removeItem('schema');

                } else {
                    messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±. Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Shopify.';
                    messageArea.style.color = 'red';
                    errorText.textContent = result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù….';
                    errorDetails.classList.remove('hidden');
                }
            } catch (error) {
                loadingIndicator.classList.add('hidden');
                messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ù…Ù„ÙØ§Øª API.';
                messageArea.style.color = 'red';
                errorText.textContent = error.message;
                errorDetails.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
