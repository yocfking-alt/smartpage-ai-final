<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Shopify</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="max-w-xl w-full bg-white p-8 rounded-xl shadow-2xl border border-gray-200 text-center">
        <h1 class="text-3xl font-bold mb-4 text-gray-900">ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø±!</h1>
        <p class="text-gray-600 mb-6">Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Custom App - Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ù†Ø´Ø± Ø§Ù„ØµÙØ­Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ù…ØªØ¬Ø±Ùƒ.</p>
        
        <div id="progress-area" class="mt-8">
            <button id="publish-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300">
                Ù†Ø´Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¢Ù†
            </button>
            
            <div id="loading-indicator" class="hidden mt-4">
                <div class="flex justify-center items-center space-x-3 text-blue-600 font-semibold">
                    <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ Shopify...</span>
                </div>
            </div>
            
            <p id="message-area" class="mt-4 text-lg font-medium"></p>
        </div>
        
        <div id="success-actions" class="mt-8 hidden">
            <a id="shopify-link" href="#" target="_blank" class="w-full inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">
                ÙØªØ­ Ø§Ù„Ù…ØªØ¬Ø± (Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)
            </a>
            <p class="text-sm text-gray-500 mt-3">Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù…Ø­Ø±Ø± Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªÙ… Ù†Ø´Ø±Ù‡.</p>
        </div>
        
        <div id="error-details" class="mt-4 p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 hidden text-sm text-right">
            <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:</strong> <span id="error-text"></span>
        </div>
    </div>
    
    <script>
        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† sessionStorage Ø¥Ù„Ù‰ localStorage
        function migrateAndGetData() {
            // Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† localStorage
            let liquidCode = localStorage.getItem('liquid_code');
            let schema = localStorage.getItem('schema');
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ÙÙŠ localStorageØŒ Ø¬Ø±Ø¨ sessionStorage
            if (!liquidCode || !schema) {
                const liquidFromSession = sessionStorage.getItem('liquid_code');
                const schemaFromSession = sessionStorage.getItem('schema');
                
                if (liquidFromSession && schemaFromSession) {
                    // Ø§Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† sessionStorage Ø¥Ù„Ù‰ localStorage
                    localStorage.setItem('liquid_code', liquidFromSession);
                    localStorage.setItem('schema', schemaFromSession);
                    liquidCode = liquidFromSession;
                    schema = schemaFromSession;
                    console.log('âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ localStorage');
                }
            }
            
            return { liquidCode, schema };
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('publish-btn').addEventListener('click', publishSection);
        });

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function publishSection() {
            const shop = getQueryParam('shop');
            
            // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const { liquidCode, schema } = migrateAndGetData();
            
            const messageArea = document.getElementById('message-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const successActions = document.getElementById('success-actions');
            const errorDetails = document.getElementById('error-details');
            const errorText = document.getElementById('error-text');
            const publishBtn = document.getElementById('publish-btn');

            if (!shop || !liquidCode || !schema) {
                messageArea.textContent = 'âŒ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù€ builder.html ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.';
                messageArea.style.color = 'red';
                return;
            }

            publishBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');

            const data = {
                shop: shop,
                liquid_code: liquidCode,
                schema: JSON.parse(schema)
            };

            try {
                const response = await fetch('/api/shopify_publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                loadingIndicator.classList.add('hidden');

                if (response.ok && result.success) {
                    messageArea.textContent = `âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${result.filename}.liquid`;
                    messageArea.style.color = 'green';
                    
                    const themeEditorLink = `https://${shop}/admin/themes/current/editor`;
                    document.getElementById('shopify-link').href = themeEditorLink;
                    successActions.classList.remove('hidden');

                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                    localStorage.removeItem('liquid_code');
                    localStorage.removeItem('schema');
                    sessionStorage.removeItem('liquid_code');
                    sessionStorage.removeItem('schema');

                } else {
                    messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±.';
                    messageArea.style.color = 'red';
                    errorText.textContent = result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    errorDetails.classList.remove('hidden');
                    publishBtn.disabled = false;
                }
            } catch (error) {
                loadingIndicator.classList.add('hidden');
                messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
                messageArea.style.color = 'red';
                errorText.textContent = error.message;
                errorDetails.classList.remove('hidden');
                publishBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
