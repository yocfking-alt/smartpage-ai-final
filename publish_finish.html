<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ุฅุชูุงู ุงููุดุฑ ุนูู Shopify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="max-w-xl w-full bg-white p-8 rounded-xl shadow-2xl border border-gray-200 text-center">
        <h1 class="text-3xl font-bold mb-4 text-gray-900">โ ูุฑุญุจุงู ุจุนูุฏุชู!</h1>
        <p class="text-gray-600 mb-6">ููุฏ ุฃูููุช ุงููุตุงุฏูุฉ ุจูุฌุงุญ. ุณูููู ุงูุขู ุจูุดุฑ ุตูุญุชู ุนูู ูุชุฌุฑู.</p>
        
        <div id="progress-area" class="mt-8">
            <button id="publish-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300">
                ุฅููุงู ุงููุดุฑ ุงูุขู
            </button>
            
            <div id="loading-indicator" class="hidden mt-4">
                <div class="flex justify-center items-center space-x-3 text-blue-600 font-semibold">
                    <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>ุฌุงุฑู ุงููุดุฑ...</span>
                </div>
            </div>

            <p id="message-area" class="mt-4 text-lg font-medium"></p>
            
            <div id="error-details" class="hidden mt-4 bg-red-100 border border-red-300 p-4 rounded-lg text-left">
                <p class="font-semibold text-red-700">โ ุฎุทุฃ ูู ุนูููุฉ ุงููุดุฑ:</p>
                <p id="error-text" class="text-sm text-red-600 mt-1 break-words"></p>
            </div>
            
            <div id="retry-section" class="hidden mt-4">
                <button id="retry-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                    ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                </button>
                <button id="back-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                    ุงูุนูุฏุฉ ููุจูุงุก
                </button>
            </div>
        </div>

        <div id="success-actions" class="hidden mt-6 pt-4 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-green-600 mb-4">ุชู ุจูุฌุงุญ!</h2>
            <p class="text-gray-700 mb-4">ููููู ุงูุขู ุชุนุฏูู ุงููุณู ูู ูุญุฑุฑ ุงูุซูู (Theme Editor) ูู ูุชุฌุฑู.</p>
            <a id="shopify-link" href="#" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">
                ูุชุญ ูุญุฑุฑ ุงูุซูู ๐
            </a>
            <button id="clear-data-btn" class="mt-4 text-sm text-gray-500 hover:text-gray-700">
                ุชูุธูู ุงูุจูุงูุงุช ุงููุญููุธุฉ
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const shop = params.get('shop');
            const data_key = params.get('data_key');
            
            const publishBtn = document.getElementById('publish-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            const messageArea = document.getElementById('message-area');
            const successActions = document.getElementById('success-actions');
            const errorDetails = document.getElementById('error-details');
            const errorText = document.getElementById('error-text');
            const retrySection = document.getElementById('retry-section');
            const retryBtn = document.getElementById('retry-btn');
            const backBtn = document.getElementById('back-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            
            // ุงูุชุญูู ูู ุงููุชุฌุฑ
            if (!shop) {
                messageArea.textContent = 'โ ุฎุทุฃ: ุงุณู ุงููุชุฌุฑ ููููุฏ ูู ุงูุฑุงุจุท.';
                messageArea.style.color = 'red';
                publishBtn.disabled = true;
                return;
            }
            
            // ุฏูุงู ูุณุงุนุฏุฉ
            function showMessage(text, color = 'gray') {
                messageArea.textContent = text;
                messageArea.style.color = color;
            }
            
            function showError(text) {
                messageArea.textContent = text;
                messageArea.style.color = 'red';
            }
            
            function showSuccess(text) {
                messageArea.textContent = text;
                messageArea.style.color = 'green';
            }
            
            // ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ูู ูุตุงุฏุฑ ูุชุนุฏุฏุฉ
            async function retrieveSectionData() {
                // 1. ูุญุงููุฉ ูู data_key (ุงููุธุงู ุงูุฌุฏูุฏ)
                if (data_key) {
                    try {
                        const response = await fetch(`/api/shopify_get_data?data_key=${data_key}&shop=${shop}`);
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            return {
                                liquid_code: result.liquid_code,
                                schema: result.schema,
                                source: 'database'
                            };
                        } else {
                            console.warn('Failed to get data from database:', result.error);
                        }
                    } catch (error) {
                        console.warn('Database retrieval failed:', error.message);
                    }
                }
                
                // 2. ูุญุงููุฉ ูู localStorage
                const localLiquid = localStorage.getItem('liquid_code');
                const localSchema = localStorage.getItem('schema');
                const pendingShop = localStorage.getItem('pending_shop');
                
                if (localLiquid && localSchema && pendingShop === shop) {
                    try {
                        return {
                            liquid_code: localLiquid,
                            schema: JSON.parse(localSchema),
                            source: 'localStorage'
                        };
                    } catch (e) {
                        console.warn('LocalStorage parse error:', e);
                    }
                }
                
                // 3. ูุญุงููุฉ ูู sessionStorage
                const sessionLiquid = sessionStorage.getItem('liquid_code');
                const sessionSchema = sessionStorage.getItem('schema');
                
                if (sessionLiquid && sessionSchema) {
                    try {
                        return {
                            liquid_code: sessionLiquid,
                            schema: JSON.parse(sessionSchema),
                            source: 'sessionStorage'
                        };
                    } catch (e) {
                        console.warn('SessionStorage parse error:', e);
                    }
                }
                
                return null;
            }
            
            // ุฏุงูุฉ ุงููุดุฑ ุงูุฑุฆูุณูุฉ
            async function publishShopifySection() {
                publishBtn.disabled = true;
                loadingIndicator.classList.remove('hidden');
                messageArea.textContent = '';
                errorDetails.classList.add('hidden');
                retrySection.classList.add('hidden');
                successActions.classList.add('hidden');
                
                try {
                    // ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช
                    const sectionData = await retrieveSectionData();
                    
                    if (!sectionData) {
                        showError('โ ูุดู ุงููุดุฑ: ุจูุงูุงุช ุงูุตูุญุฉ ููููุฏุฉ.');
                        errorText.textContent = 'ุงูุจูุงูุงุช ุบูุฑ ูุชููุฑุฉ ูู ุฃู ูุตุฏุฑ (ูุงุนุฏุฉ ุจูุงูุงุชุ localStorageุ sessionStorage).';
                        errorDetails.classList.remove('hidden');
                        retrySection.classList.remove('hidden');
                        return;
                    }
                    
                    console.log('Using data from:', sectionData.source);
                    
                    // ุงูุชุญูู ูู ุชุทุงุจู ุงููุชุฌุฑ
                    const pendingShop = localStorage.getItem('pending_shop') || sessionStorage.getItem('pending_shop');
                    if (pendingShop && pendingShop !== shop) {
                        showError(`โ ูุดู ุงููุดุฑ: ุงููุชุฌุฑ ุงูุญุงูู (${shop}) ูุง ูุชุทุงุจู ูุน ุงููุชุฌุฑ ุงููุณุฌู (${pendingShop}).`);
                        retrySection.classList.remove('hidden');
                        return;
                    }
                    
                    // ุฅุฑุณุงู ุทูุจ ุงููุดุฑ
                    const response = await fetch('/api/shopify_publish', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            shop: shop,
                            liquid_code: sectionData.liquid_code,
                            schema: sectionData.schema
                        })
                    });
                    
                    const result = await response.json();
                    loadingIndicator.classList.add('hidden');
                    
                    if (response.ok && result.success) {
                        showSuccess(`โ ุชู ุงููุดุฑ ุจูุฌุงุญ! ุงุณู ุงูููู: ${result.filename}`);
                        
                        // ุจูุงุก ุฑุงุจุท ูุญุฑุฑ ุงูุซูู
                        const themeEditorLink = `https://${shop}/admin/themes/current/editor?context=apps&template=index&activateAppSection=${result.filename.replace('.liquid', '')}`;
                        
                        document.getElementById('shopify-link').href = themeEditorLink;
                        successActions.classList.remove('hidden');
                        
                        // ุชูุธูู ุงูุจูุงูุงุช ุจุนุฏ ุงููุฌุงุญ
                        cleanupStoredData();
                        
                    } else if (result.action_required) {
                        showError('โ ูุดู ุงููุดุฑ: ุฑูุฒ ุงููุตูู ุบูุฑ ุตุงูุญ.');
                        errorText.textContent = result.error;
                        errorDetails.classList.remove('hidden');
                        retrySection.classList.remove('hidden');
                    } else {
                        showError('โ ูุดู ุงููุดุฑ.');
                        errorText.textContent = result.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
                        errorDetails.classList.remove('hidden');
                        retrySection.classList.remove('hidden');
                    }
                    
                } catch (error) {
                    loadingIndicator.classList.add('hidden');
                    showError('โ ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู.');
                    errorText.textContent = error.message;
                    errorDetails.classList.remove('hidden');
                    retrySection.classList.remove('hidden');
                }
            }
            
            // ุชูุธูู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ
            function cleanupStoredData() {
                localStorage.removeItem('liquid_code');
                localStorage.removeItem('schema');
                localStorage.removeItem('pending_shop');
                sessionStorage.removeItem('liquid_code');
                sessionStorage.removeItem('schema');
                sessionStorage.removeItem('pending_shop');
            }
            
            // ุชุดุบูู ุงููุดุฑ ุชููุงุฆูุงู
            setTimeout(() => {
                publishBtn.click();
            }, 500);
            
            // ุฅุถุงูุฉ Event Listeners
            publishBtn.addEventListener('click', publishShopifySection);
            
            retryBtn?.addEventListener('click', () => {
                publishShopifySection();
            });
            
            backBtn?.addEventListener('click', () => {
                window.location.href = '/builder.html';
            });
            
            clearDataBtn?.addEventListener('click', () => {
                cleanupStoredData();
                alert('ุชู ุชูุธูู ุงูุจูุงูุงุช ุงููุญููุธุฉ ุจูุฌุงุญ.');
            });
        });
    </script>
</body>
</html>
