<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Shopify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="max-w-xl w-full bg-white p-8 rounded-xl shadow-2xl border border-gray-200 text-center">
        <h1 class="text-3xl font-bold mb-4 text-gray-900">âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!</h1>
        <p class="text-gray-600 mb-6">Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨Ù†Ø´Ø± ØµÙØ­ØªÙƒ Ø¹Ù„Ù‰ Ù…ØªØ¬Ø±Ùƒ.</p>
        
        <div id="progress-area" class="mt-8">
            <button id="publish-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300">
                Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø¢Ù†
            </button>
            
            <div id="loading-indicator" class="hidden mt-4">
                <div class="flex justify-center items-center space-x-3 text-blue-600 font-semibold">
                    <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Ø¬Ø§Ø±Ù Ø§Ù„Ù†Ø´Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Access Token...</span>
                </div>
            </div>

            <p id="message-area" class="mt-4 text-lg font-medium"></p>
            
            <div id="error-details" class="hidden mt-4 bg-red-100 border border-red-300 p-4 rounded-lg text-left">
                <p class="font-semibold text-red-700">âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø±:</p>
                <p id="error-text" class="text-sm text-red-600 mt-1 break-words"></p>
            </div>
            
        </div>

        <div id="success-actions" class="hidden mt-6 pt-4 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-green-600 mb-4">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <p class="text-gray-700 mb-4">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ù…Ø­Ø±Ø± Ø§Ù„Ø«ÙŠÙ… (Theme Editor) ÙÙŠ Ù…ØªØ¬Ø±Ùƒ.</p>
            <a id="shopify-link" href="#" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">
                ÙØªØ­ Ù…Ø­Ø±Ø± Ø§Ù„Ø«ÙŠÙ… ğŸš€
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const shop = params.get('shop'); // Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø°ÙŠ Ø¬Ø§Ø¡ Ù…Ù† shopify_callback.js
            
            const publishBtn = document.getElementById('publish-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            const messageArea = document.getElementById('message-area');
            const successActions = document.getElementById('success-actions');
            const errorDetails = document.getElementById('error-details');
            const errorText = document.getElementById('error-text');
            
            // âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø± (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø³Ù„Ø§Ù…Ø©)
            if (!shop) {
                messageArea.textContent = 'âŒ Ø®Ø·Ø£: Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.';
                messageArea.style.color = 'red';
                publishBtn.disabled = true;
                return;
            }

            // ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„ØªÙˆÙÙŠØ± Ø®Ø·ÙˆØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
            if (publishBtn) {
                 publishBtn.click();
            }

            // ********* Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© *********
            async function publishShopifySection() {
                publishBtn.disabled = true;
                loadingIndicator.classList.remove('hidden');
                messageArea.textContent = '';
                errorDetails.classList.add('hidden');
                successActions.classList.add('hidden');

                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
                // ÙŠØªÙ… Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ builder.html Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ø¹Ù…Ù„ÙŠØ© OAuth
                const liquid_code = localStorage.getItem('liquid_code');
                const schemaJson = localStorage.getItem('schema');
                const pendingShop = localStorage.getItem('pending_shop');
                
                // âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!liquid_code || !schemaJson) {
                    messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙØ­Ø© Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø©.';
                    messageArea.style.color = 'red';
                    publishBtn.disabled = true;
                    loadingIndicator.classList.add('hidden');
                    return;
                }
                
                // âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…ØªØ¬Ø± (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§ÙˆÙ„ Ø§Ù„Ù†Ø´Ø± Ù…Ø±ØªÙŠÙ† Ù„Ù…ØªØ¬Ø±ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†)
                if (pendingShop && pendingShop !== shop) {
                    messageArea.textContent = `âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± ( ${shop} ) Ù„Ø§ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø°ÙŠ Ø¨Ø¯Ø£Øª Ù…Ù†Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ( ${pendingShop} ).`;
                    messageArea.style.color = 'red';
                    publishBtn.disabled = true;
                    loadingIndicator.classList.add('hidden');
                    return;
                }

                // 2. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ API
                try {
                    const response = await fetch('/api/shopify_publish', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            shop: shop,
                            liquid_code: liquid_code,
                            schema: JSON.parse(schemaJson)
                        })
                    });

                    const result = await response.json();
                    loadingIndicator.classList.add('hidden');

                    if (response.ok && result.success) {
                        messageArea.textContent = `âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${result.filename}`;
                        messageArea.style.color = 'green';
                        
                        // Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù…Ø­Ø±Ø± Ø§Ù„Ø«ÙŠÙ…
                        const themeEditorLink = `https://${shop}/admin/themes/current/editor?context=apps&template=index&activateAppSection=${result.filename.replace('.liquid', '')}`;
                        
                        document.getElementById('shopify-link').href = themeEditorLink;
                        successActions.classList.remove('hidden');

                        // ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù†Ø§Ø¬Ø­
                        localStorage.removeItem('liquid_code');
                        localStorage.removeItem('schema');
                        localStorage.removeItem('pending_shop'); 

                    } else if (result.action_required) {
                         // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù€ CallbackØŒ Ù‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø®Ø·Ø£ ÙÙŠ Token.
                         messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.';
                         messageArea.style.color = 'red';
                         errorText.textContent = 'Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£: ' + result.error;
                         errorDetails.classList.remove('hidden');
                    } else {
                        messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±.';
                        messageArea.style.color = 'red';
                        errorText.textContent = result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        errorDetails.classList.remove('hidden');
                        publishBtn.disabled = false;
                    }
                } catch (error) {
                    loadingIndicator.classList.add('hidden');
                    messageArea.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
                    messageArea.style.color = 'red';
                    errorText.textContent = error.message;
                    errorDetails.classList.remove('hidden');
                    publishBtn.disabled = false;
                }
            }

            publishBtn.addEventListener('click', publishShopifySection);
            
            // ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªÙˆÙÙŠØ± Ø®Ø·ÙˆØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            // if (publishBtn) { publishBtn.click(); }
        });
    </script>
</body>
</html>
